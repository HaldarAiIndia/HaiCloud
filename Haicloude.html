<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HaiCloude | Local HTML Manager</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --bg-primary: #17181a;
            --bg-secondary: #202225;
            --bg-tertiary: #2c2f33;
            --bg-code: #101214;
            --bg-hover: #35383c;
            --text-primary: #f0f2f5;
            --text-secondary: #a8b3cf;
            --color-accent: #82aaff;
            --color-border: #3a3d42;
            --color-error: #ff8a80;
            --color-success: #69f0ae;
            --color-warning: #ffd54f;
            --sidebar-width: 260px;
            --header-height: 60px;
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            overflow: hidden; /* App-like feel */
            height: 100vh;
            display: flex;
        }

        button { cursor: pointer; border: none; background: none; color: inherit; font-family: inherit; }
        a { text-decoration: none; color: var(--color-accent); }
        ul { list-style: none; }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-border); }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .logo-area {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 24px;
            font-weight: 600;
            font-size: 1.2rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--color-border);
        }
        .logo-area span { color: var(--color-accent); margin-right: 8px; }

        .nav-links { padding: 20px 12px; flex: 1; }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--text-secondary);
            border-radius: 8px;
            margin-bottom: 4px;
            transition: var(--transition);
        }
        .nav-item:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background-color: var(--bg-hover); color: var(--color-accent); font-weight: 500; }
        .nav-item .material-symbols-outlined { margin-right: 12px; font-size: 20px; }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--color-border);
        }
        .sidebar-footer button {
            width: 100%;
            padding: 10px;
            text-align: left;
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            border-radius: 6px;
        }
        .sidebar-footer button:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .sidebar-footer i { margin-right: 10px; font-size: 18px; }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .top-bar {
            height: var(--header-height);
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }
        
        .menu-toggle { display: none; margin-right: 16px; }
        .page-title { font-weight: 600; font-size: 1.1rem; }
        
        .top-actions button {
            padding: 8px;
            border-radius: 6px;
            color: var(--text-secondary);
            margin-left: 8px;
            transition: var(--transition);
        }
        .top-actions button:hover { background-color: var(--bg-hover); color: var(--text-primary); }

        .scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* --- DASHBOARD COMPONENTS --- */
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--color-border);
        }
        .stat-label { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 8px; }
        .stat-value { font-size: 1.8rem; font-weight: 600; color: var(--text-primary); }
        .stat-icon { float: right; color: var(--bg-tertiary); font-size: 2rem; }

        /* Upload Zone */
        .upload-zone {
            background-color: var(--bg-secondary);
            border: 2px dashed var(--color-border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: var(--transition);
            cursor: pointer;
        }
        .upload-zone.drag-over { border-color: var(--color-accent); background-color: rgba(130, 170, 255, 0.05); }
        .upload-zone i { font-size: 48px; color: var(--color-accent); margin-bottom: 16px; }
        .upload-zone h3 { margin-bottom: 8px; font-weight: 500; }
        .upload-zone p { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px; }
        .btn-primary {
            background-color: var(--color-accent);
            color: #fff;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 500;
            display: inline-block;
        }
        .btn-primary:hover { opacity: 0.9; }

        /* File List */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .file-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 16px;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }
        .file-card:hover { transform: translateY(-2px); border-color: var(--text-secondary); }
        
        .file-header { display: flex; align-items: flex-start; margin-bottom: 12px; }
        .file-icon { 
            background: var(--bg-tertiary); width: 40px; height: 40px; 
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            color: var(--color-accent); margin-right: 12px;
        }
        .file-info { flex: 1; overflow: hidden; }
        .file-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .file-meta { font-size: 0.75rem; color: var(--text-secondary); }

        .url-bar {
            background-color: var(--bg-code);
            padding: 8px;
            border-radius: 6px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .url-bar span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .url-bar:hover { color: var(--text-primary); }

        .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: auto;
            border-top: 1px solid var(--bg-tertiary);
            padding-top: 12px;
        }
        .btn-icon {
            padding: 6px;
            border-radius: 4px;
            color: var(--text-secondary);
            display: flex;
            align-items: center; justify-content: center;
        }
        .btn-icon:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .btn-icon.danger:hover { color: var(--color-error); background-color: rgba(255, 138, 128, 0.1); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden;
            transition: var(--transition);
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        
        .modal {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex; flex-direction: column;
            transform: scale(0.95);
            transition: var(--transition);
            border: 1px solid var(--color-border);
        }
        .modal-overlay.open .modal { transform: scale(1); }
        .modal.small { max-width: 400px; }
        .modal.full { width: 95%; height: 90vh; max-width: 1200px; }

        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--color-border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-weight: 600; font-size: 1.1rem; }
        
        .modal-body { padding: 24px; flex: 1; overflow-y: auto; }
        .modal-body.no-pad { padding: 0; }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--color-border);
            display: flex; justify-content: flex-end; gap: 12px;
        }

        .btn-secondary {
            padding: 8px 16px; border-radius: 6px;
            background: var(--bg-tertiary); color: var(--text-primary);
            font-size: 0.9rem;
        }
        .btn-secondary:hover { background: var(--bg-hover); }
        
        .btn-danger {
            padding: 8px 16px; border-radius: 6px;
            background: var(--color-error); color: var(--bg-primary);
            font-size: 0.9rem; font-weight: 500;
        }
        .btn-danger:hover { opacity: 0.9; }

        /* EDITOR & PREVIEW */
        .code-editor {
            width: 100%; height: 100%; min-height: 400px;
            background-color: var(--bg-code);
            color: var(--text-primary);
            border: none; padding: 20px;
            font-family: 'Roboto Mono', monospace;
            font-size: 14px; line-height: 1.5;
            resize: none;
        }
        iframe.preview-frame {
            width: 100%; height: 100%;
            border: none; background: #fff;
        }

        /* --- TOAST --- */
        .toast-container {
            position: fixed; bottom: 24px; left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
        }
        .toast {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px;
            transform: translateY(100px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid var(--color-border);
        }
        .toast.visible { transform: translateY(0); }
        .toast.success i { color: var(--color-success); }
        .toast.error i { color: var(--color-error); }

        /* --- EMPTY STATE --- */
        .empty-state {
            text-align: center; padding: 40px;
            color: var(--text-secondary);
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed; top: 0; bottom: 0; left: 0;
                transform: translateX(-100%);
            }
            .sidebar.show { transform: translateX(0); }
            .menu-toggle { display: block; }
            .sidebar-overlay {
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 99;
                opacity: 0; visibility: hidden; transition: var(--transition);
            }
            .sidebar-overlay.show { opacity: 1; visibility: visible; }
        }

        @media (max-width: 640px) {
            .stats-grid { grid-template-columns: 1fr; }
            .file-grid { grid-template-columns: 1fr; }
            .upload-zone { padding: 20px; }
            .modal-footer { flex-direction: column; }
            .modal-footer button { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-container">
        <nav class="sidebar" id="sidebar">
            <div class="logo-area">
                <span class="material-symbols-outlined">bolt</span>
                HaiCloude
            </div>
            
            <ul class="nav-links">
                <li>
                    <button class="nav-item active" onclick="App.navigate('home')">
                        <span class="material-symbols-outlined">dashboard</span>
                        Dashboard
                    </button>
                </li>
                <li>
                    <button class="nav-item" onclick="App.navigate('history')">
                        <span class="material-symbols-outlined">history</span>
                        History
                    </button>
                </li>
            </ul>

            <div class="sidebar-footer">
                <button onclick="DB.exportData()">
                    <i class="material-symbols-outlined">download</i> Export Data
                </button>
                <button onclick="UI.showModal('aboutModal')">
                    <i class="material-symbols-outlined">info</i> About
                </button>
            </div>
        </nav>

        <main class="main-content">
            <header class="top-bar">
                <div style="display:flex; align-items:center;">
                    <button class="menu-toggle" id="menuToggle">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <h2 class="page-title" id="pageTitle">Dashboard</h2>
                </div>
                <div class="top-actions">
                    <button title="Refresh" onclick="App.refresh()"><span class="material-symbols-outlined">refresh</span></button>
                    <button title="Clear All" onclick="App.confirmClearAll()"><span class="material-symbols-outlined">delete_sweep</span></button>
                </div>
            </header>

            <div class="scroll-area">
                
                <div id="view-home">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="material-symbols-outlined stat-icon">folder</span>
                            <div class="stat-label">Total Files</div>
                            <div class="stat-value" id="statFiles">0</div>
                        </div>
                        <div class="stat-card">
                            <span class="material-symbols-outlined stat-icon">visibility</span>
                            <div class="stat-label">Total Views</div>
                            <div class="stat-value" id="statViews">0</div>
                        </div>
                        <div class="stat-card">
                            <span class="material-symbols-outlined stat-icon">database</span>
                            <div class="stat-label">Storage Used</div>
                            <div class="stat-value" id="statStorage">0 KB</div>
                        </div>
                    </div>

                    <div class="upload-zone" id="dropZone">
                        <input type="file" id="fileInput" accept=".html,.htm" multiple hidden>
                        <i class="material-symbols-outlined">cloud_upload</i>
                        <h3>Upload HTML Files</h3>
                        <p>Drag & drop your files here or click to browse</p>
                        <button class="btn-primary" onclick="document.getElementById('fileInput').click()">Choose Files</button>
                    </div>

                    <div class="section-header">
                        <h3>Recent Uploads</h3>
                    </div>
                </div>

                <div id="fileListContainer" class="file-grid">
                    </div>
                <div id="emptyState" class="empty-state" style="display:none;">
                    <span class="material-symbols-outlined" style="font-size:48px; opacity:0.5;">inbox</span>
                    <p>No files hosted yet.</p>
                </div>
            </div>
        </main>
    </div>

    <div class="toast-container">
        <div id="toast" class="toast">
            <i class="material-symbols-outlined" id="toastIcon">check_circle</i>
            <span id="toastMessage">Operation successful</span>
        </div>
    </div>

    <div class="modal-overlay" id="previewModal">
        <div class="modal full">
            <div class="modal-header">
                <span class="modal-title" id="previewTitle">Preview</span>
                <button onclick="UI.hideModal('previewModal')"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal-body no-pad">
                <iframe id="previewFrame" class="preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editorModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Edit Code</span>
                <button onclick="UI.hideModal('editorModal')"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal-body no-pad">
                <textarea id="codeEditor" class="code-editor" spellcheck="false"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="UI.hideModal('editorModal')">Cancel</button>
                <button class="btn-primary" onclick="App.saveEditedFile()">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal small">
            <div class="modal-header">
                <span class="modal-title">Delete File?</span>
                <button onclick="UI.hideModal('deleteModal')"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <b id="deleteFileName">file.html</b>?</p>
                <p style="font-size:0.9rem; color:var(--text-secondary); margin-top:8px;">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="UI.hideModal('deleteModal')">Cancel</button>
                <button class="btn-danger" onclick="App.executeDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="aboutModal">
        <div class="modal small">
            <div class="modal-header">
                <span class="modal-title">About HaiCloude</span>
                <button onclick="UI.hideModal('aboutModal')"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal-body">
                <p><b>HaiCloude v1.0</b></p>
                <p style="margin-top:10px; color:var(--text-secondary);">
                    A serverless, single-file web host application. All data is stored locally in your browser (LocalStorage).
                </p>
                <p style="margin-top:10px; color:var(--text-secondary);">
                    Designed for quick prototyping, code snippets, and offline HTML viewing.
                </p>
            </div>
        </div>
    </div>

    <script>
        /**
         * HaiCloude - Architecture
         * 1. DB: LocalStorage wrapper & Data logic
         * 2. UI: DOM manipulation & Rendering
         * 3. App: Controller, Events & State
         */

        /* --- LAYER 1: DATABASE --- */
        const DB = {
            KEY_FILES: 'quickhost_files_v2',
            KEY_STATS: 'quickhost_stats_v2',

            init() {
                if (!localStorage.getItem(this.KEY_FILES)) localStorage.setItem(this.KEY_FILES, '[]');
                if (!localStorage.getItem(this.KEY_STATS)) {
                    localStorage.setItem(this.KEY_STATS, JSON.stringify({ totalViews: 0, totalFiles: 0 }));
                }
            },

            getAllFiles() {
                try {
                    return JSON.parse(localStorage.getItem(this.KEY_FILES) || '[]');
                } catch (e) { return []; }
            },

            getStats() {
                try {
                    return JSON.parse(localStorage.getItem(this.KEY_STATS));
                } catch(e) { return { totalViews: 0, totalFiles: 0 }; }
            },

            saveFiles(files) {
                localStorage.setItem(this.KEY_FILES, JSON.stringify(files));
                this.updateStatsCount(files.length);
                return true;
            },

            createFile({ name, content }) {
                const files = this.getAllFiles();
                const id = 'f_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const newFile = {
                    id,
                    name,
                    content,
                    url: `quickhost://view/${id}`, // Simulated URL
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    views: 0,
                    size: new Blob([content]).size
                };
                files.unshift(newFile);
                this.saveFiles(files);
                return newFile;
            },

            updateFile(id, content) {
                const files = this.getAllFiles();
                const index = files.findIndex(f => f.id === id);
                if (index !== -1) {
                    files[index].content = content;
                    files[index].updatedAt = new Date().toISOString();
                    files[index].size = new Blob([content]).size;
                    this.saveFiles(files);
                    return files[index];
                }
                return null;
            },

            deleteFile(id) {
                let files = this.getAllFiles();
                files = files.filter(f => f.id !== id);
                this.saveFiles(files);
            },

            getFile(id) {
                const files = this.getAllFiles();
                return files.find(f => f.id === id);
            },

            incrementView(id) {
                const files = this.getAllFiles();
                const index = files.findIndex(f => f.id === id);
                if (index !== -1) {
                    files[index].views += 1;
                    this.saveFiles(files);
                    
                    // Update global stats
                    const stats = this.getStats();
                    stats.totalViews += 1;
                    localStorage.setItem(this.KEY_STATS, JSON.stringify(stats));
                }
            },

            updateStatsCount(count) {
                const stats = this.getStats();
                stats.totalFiles = count;
                localStorage.setItem(this.KEY_STATS, JSON.stringify(stats));
            },

            getStorageSize() {
                let total = 0;
                const files = this.getAllFiles();
                files.forEach(f => total += f.size);
                return total;
            },

            clearAll() {
                localStorage.removeItem(this.KEY_FILES);
                localStorage.removeItem(this.KEY_STATS);
                this.init();
            },

            exportData() {
                const data = {
                    files: this.getAllFiles(),
                    stats: this.getStats(),
                    exportedAt: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quickhost_backup_${Date.now()}.json`;
                a.click();
            }
        };

        /* --- LAYER 2: UI --- */
        const UI = {
            init() {
                this.els = {
                    fileList: document.getElementById('fileListContainer'),
                    emptyState: document.getElementById('emptyState'),
                    statFiles: document.getElementById('statFiles'),
                    statViews: document.getElementById('statViews'),
                    statStorage: document.getElementById('statStorage'),
                    viewHome: document.getElementById('view-home'),
                    pageTitle: document.getElementById('pageTitle'),
                    dropZone: document.getElementById('dropZone'),
                    sidebar: document.getElementById('sidebar'),
                    overlay: document.getElementById('sidebarOverlay')
                };
            },

            formatSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },

            formatDate(isoString) {
                const date = new Date(isoString);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if (diffDays === 1) return 'Today';
                if (diffDays === 2) return 'Yesterday';
                return date.toLocaleDateString();
            },

            renderStats() {
                const stats = DB.getStats();
                const size = DB.getStorageSize();
                this.els.statFiles.textContent = stats.totalFiles;
                this.els.statViews.textContent = stats.totalViews;
                this.els.statStorage.textContent = this.formatSize(size);
            },

            renderFiles(filter = 'all') {
                const files = DB.getAllFiles();
                this.els.fileList.innerHTML = '';

                if (files.length === 0) {
                    this.els.emptyState.style.display = 'block';
                    return;
                }
                this.els.emptyState.style.display = 'none';

                // Simple filter logic (can be expanded)
                let displayFiles = files;
                if(filter === 'history') {
                    // Just an example, history view could be sorted differently
                    displayFiles = files.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                }

                displayFiles.forEach(file => {
                    const html = `
                        <div class="file-card">
                            <div class="file-header">
                                <div class="file-icon">
                                    <span class="material-symbols-outlined">html</span>
                                </div>
                                <div class="file-info">
                                    <div class="file-name" title="${file.name}">${file.name}</div>
                                    <div class="file-meta">
                                        ${this.formatDate(file.createdAt)} • ${this.formatSize(file.size)} • ${file.views} views
                                    </div>
                                </div>
                            </div>
                            <div class="url-bar" onclick="App.copyUrl('${file.url}')" title="Click to copy URL">
                                <span>${file.url}</span>
                                <span class="material-symbols-outlined" style="font-size:14px">content_copy</span>
                            </div>
                            <div class="card-actions">
                                <button class="btn-icon" onclick="App.previewFile('${file.id}')" title="Preview">
                                    <span class="material-symbols-outlined">visibility</span>
                                </button>
                                <button class="btn-icon" onclick="App.editFile('${file.id}')" title="Edit Code">
                                    <span class="material-symbols-outlined">code</span>
                                </button>
                                <button class="btn-icon danger" onclick="App.confirmDelete('${file.id}')" title="Delete">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                        </div>
                    `;
                    this.els.fileList.insertAdjacentHTML('beforeend', html);
                });
            },

            showModal(id) {
                document.getElementById(id).classList.add('open');
            },

            hideModal(id) {
                document.getElementById(id).classList.remove('open');
                // Clean up iframe to stop audio/video if playing
                if(id === 'previewModal') {
                    document.getElementById('previewFrame').srcdoc = '';
                }
            },

            showToast(msg, type = 'success') {
                const toast = document.getElementById('toast');
                const icon = document.getElementById('toastIcon');
                const text = document.getElementById('toastMessage');
                
                text.textContent = msg;
                icon.textContent = type === 'success' ? 'check_circle' : 'error';
                icon.parentElement.className = `toast ${type}`; // reset classes
                
                toast.classList.add('visible');
                setTimeout(() => toast.classList.remove('visible'), 3000);
            },

            toggleSidebar() {
                this.els.sidebar.classList.toggle('show');
                this.els.overlay.classList.toggle('show');
            }
        };

        /* --- LAYER 3: APP CONTROLLER --- */
        const App = {
            state: {
                currentEditId: null,
                currentDeleteId: null,
                view: 'home'
            },

            init() {
                DB.init();
                UI.init();
                this.setupEventListeners();
                this.render();
            },

            render() {
                UI.renderStats();
                UI.renderFiles(this.state.view);
            },

            navigate(view) {
                this.state.view = view;
                
                // Toggle UI Sections
                const homeView = document.getElementById('view-home');
                const title = document.getElementById('pageTitle');
                const navItems = document.querySelectorAll('.nav-item');
                
                navItems.forEach(n => n.classList.remove('active'));
                
                if (view === 'home') {
                    homeView.style.display = 'block';
                    title.textContent = 'Dashboard';
                    navItems[0].classList.add('active');
                } else {
                    homeView.style.display = 'none'; // Hide upload/stats
                    title.textContent = 'File History';
                    navItems[1].classList.add('active');
                }

                this.render();
                
                // Mobile: Close sidebar on nav
                if(window.innerWidth <= 1024) UI.toggleSidebar();
            },

            setupEventListeners() {
                // Drag & Drop
                const dropZone = UI.els.dropZone;
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    }, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
                });

                dropZone.addEventListener('drop', (e) => this.handleFiles(e.dataTransfer.files), false);
                
                // File Input
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFiles(e.target.files));

                // Mobile Menu
                document.getElementById('menuToggle').addEventListener('click', () => UI.toggleSidebar());
                document.getElementById('sidebarOverlay').addEventListener('click', () => UI.toggleSidebar());

                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal-overlay.open').forEach(el => el.classList.remove('open'));
                        document.getElementById('previewFrame').srcdoc = '';
                    }
                });
            },

            handleFiles(fileList) {
                const files = [...fileList];
                let uploadedCount = 0;

                files.forEach(file => {
                    if (file.type === 'text/html' || file.name.endsWith('.html') || file.name.endsWith('.htm')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            DB.createFile({
                                name: file.name,
                                content: e.target.result
                            });
                            uploadedCount++;
                            if (uploadedCount === files.length) {
                                this.render();
                                UI.showToast(`Uploaded ${uploadedCount} file(s)`);
                            }
                        };
                        reader.readAsText(file);
                    } else {
                        UI.showToast('Only HTML files are supported', 'error');
                    }
                });
            },

            previewFile(id) {
                const file = DB.getFile(id);
                if (!file) return;

                DB.incrementView(id);
                this.render(); // update view count in UI

                document.getElementById('previewTitle').textContent = file.name;
                document.getElementById('previewFrame').srcdoc = file.content;
                UI.showModal('previewModal');
            },

            editFile(id) {
                const file = DB.getFile(id);
                if (!file) return;

                this.state.currentEditId = id;
                document.getElementById('codeEditor').value = file.content;
                UI.showModal('editorModal');
            },

            saveEditedFile() {
                const content = document.getElementById('codeEditor').value;
                if (this.state.currentEditId) {
                    DB.updateFile(this.state.currentEditId, content);
                    UI.hideModal('editorModal');
                    UI.showToast('File saved successfully');
                    this.render();
                }
            },

            confirmDelete(id) {
                const file = DB.getFile(id);
                if(!file) return;
                
                this.state.currentDeleteId = id;
                document.getElementById('deleteFileName').textContent = file.name;
                UI.showModal('deleteModal');
            },

            executeDelete() {
                if (this.state.currentDeleteId) {
                    DB.deleteFile(this.state.currentDeleteId);
                    UI.hideModal('deleteModal');
                    UI.showToast('File deleted');
                    this.render();
                }
            },

            copyUrl(url) {
                // Since this is local, we just copy the text string
                navigator.clipboard.writeText(url).then(() => {
                    UI.showToast('URL copied to clipboard');
                });
            },

            confirmClearAll() {
                if(confirm('Are you sure you want to delete ALL files? This cannot be undone.')) {
                    DB.clearAll();
                    this.render();
                    UI.showToast('All data cleared');
                }
            },

            refresh() {
                this.render();
                UI.showToast('Data refreshed');
            }
        };

        // Start Application
        window.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>