<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO & Metadata -->
    <title>HaiCloud</title>
    <meta name="description" content="HaiCloud is a secure, cloud-based text and code editor powered by HaldarAi. Upload, edit, and manage your HTML, CSS, JS, and Python snippets from anywhere.">
    <meta name="keywords" content="cloud text editor, online code manager, firebase storage, html preview, javascript editor, pwa, haicloud">
    <meta name="author" content="HaiCloud">
    <meta name="theme-color" content="#17181a">
    
    <!-- Open Graph / Social -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="HaiCloud">
    <meta property="og:description" content="Store, edit, and preview your code snippets securely in the cloud.">
    <meta property="og:site_name" content="HaiCloud">

    <!-- PWA & Mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HaiCloud">

    <!-- Favicon (SVG Cloud Icon) -->
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">

    <!-- Web App Manifest (Data URI) -->
    <link rel="manifest" href="/Manifest.json">

    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0" />

    <style>
        /* --- START OF FILE aistudio_Style.css --- */
        :root {
            --bg-primary: #17181a;
            --bg-secondary: #202225;
            --bg-tertiary: #2c2f33;
            --bg-code: #101214;
            --bg-hover: #35383c;
            --text-primary: #f0f2f5;
            --text-secondary: #a8b3cf;
            --text-active: #82aaff;
            --border-color: #3a3d42;
            --error-color: #ff8a80;
            --sidebar-width: 260px;
            --font-family: 'Inter', sans-serif;
            --font-family-code: 'Roboto Mono', monospace;
        }

        /* --- Base & Reset --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg-primary); color: var(--text-primary); font-family: var(--font-family); font-size: 16px; }
        button, a { background: none; border: none; cursor: pointer; color: inherit; text-decoration: none; font-family: inherit; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; font-size: 20px; color: var(--text-secondary); transition: color 0.2s; user-select: none; }

        /* --- Accessibility --- */
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        *:focus-visible { outline: 2px solid var(--text-active); outline-offset: 2px; border-radius: 4px; }

        /* --- Main Layout --- */
        .app-container { display: flex; width: 100%; height: 100%; }
        .main-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .main-header { display: flex; align-items: center; padding: 12px 24px; background-color: rgba(23, 24, 26, 0.7); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color); flex-shrink: 0; position: sticky; top: 0; z-index: 100; }
        .header-title { font-size: 1.1rem; font-weight: 600; margin-left: 12px; }
        .icon-button { padding: 8px; border-radius: 50%; display: flex; transition: background-color 0.2s; }
        .icon-button:hover { background-color: var(--bg-hover); }
        .content-area { flex-grow: 1; overflow: hidden; position: relative; }

        /* --- Sidebar --- */
        #left-sidebar { position: fixed; top: 0; left: 0; height: 100%; width: var(--sidebar-width); max-width: 85%; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 1001; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        body.left-sidebar-open #left-sidebar { transform: translateX(0); }
        .sidebar-content { padding: 16px; display: flex; flex-direction: column; flex-grow: 1; overflow-y: auto; }
        .sidebar-header { font-size: 1.75rem; font-weight: 700; padding: 12px; margin-bottom: 24px; }
        .sidebar-nav a, .sidebar-nav button { font-size: 1em; display: flex; align-items: center; gap: 16px; padding: 12px; border-radius: 8px; font-weight: 500; transition: background-color 0.2s, color 0.2s, opacity 0.2s; color: var(--text-secondary); text-align: left; width: 100%; }
        .sidebar-nav a:hover, .sidebar-nav button:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .sidebar-nav a.active { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .sidebar-nav .material-symbols-outlined { color: var(--text-secondary); }
        .sidebar-nav a:hover .material-symbols-outlined, .sidebar-nav a.active .material-symbols-outlined, .sidebar-nav button:hover .material-symbols-outlined { color: var(--text-primary); }
        .sidebar-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border-color); }

        /* --- Screen Layout --- */
        .screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .screen.active { display: block; }
        
        /* FIXED: Added #viewer-screen here so the code view can scroll */
        #home-screen, #files-screen, #profile-screen, #viewer-screen { overflow-y: auto; padding: 16px 8px; }
        
        .content-wrapper { max-width: 820px; width: 100%; margin: 0 auto; padding: 16px 0; }
        .page-header { margin-bottom: 24px; padding: 0 16px;}
        .page-header h2 { font-size: 1.75rem; }

        /* --- Home Screen --- */
        .home-header { text-align: center; margin-bottom: 40px; padding: 0 16px; }
        .home-header h1 { font-size: 2.5rem; margin-bottom: 8px; }
        .home-header p { font-size: 1.1rem; color: var(--text-secondary); }
        .suggestion-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; padding: 0 16px; }
        .suggestion-card { display: block; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; transition: background-color 0.2s, border-color 0.2s; cursor: pointer; }
        body:not(.touch-device) .suggestion-card:hover { background-color: var(--bg-tertiary); border-color: #4f5257; }
        .suggestion-card .material-symbols-outlined { margin-bottom: 12px; color: var(--text-secondary); }
        .suggestion-card h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
        .suggestion-card p { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.6; }

        /* --- History Screen (Used for File List) --- */
        #history-list-container { padding: 0 16px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-secondary); border-radius: 8px; padding: 16px; border: 1px solid var(--border-color); margin-bottom: 12px; transition: background-color 0.2s, border-color 0.2s; cursor: pointer;}
        body:not(.touch-device) .history-item:hover { background-color: var(--bg-tertiary); border-color: #4f5257; }
        .history-item-info { flex-grow: 1; overflow: hidden; }
        .history-item p { font-size: 1rem; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item span { font-size: 0.85rem; color: var(--text-secondary); }
        .file-actions { display: flex; gap: 4px; }

        /* --- Chat Screen (Used for File Viewer) --- */
        #chat-screen.active { display: flex; flex-direction: column; position: relative; }
        .chat-container { flex-grow: 1; overflow-y: auto; padding: 16px 8px; scroll-behavior: smooth; }
        .chat-content-wrapper { display: flex; flex-direction: column; gap: 32px; max-width: 820px; width: 100%; margin: 0 auto; padding: 16px; }
        .chat-message { position: relative; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; }
        .message-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px 0; }
        .message-role { font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* --- Code Box & Editor --- */
        .code-box { background-color: var(--bg-code); border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; margin: 1em 0; position: relative; }
        .code-box-header { display: flex; align-items: center; justify-content: flex-end; gap: 8px; background-color: var(--bg-tertiary); padding: 8px 12px; border-bottom: 1px solid var(--border-color); }
        .code-box-header .lang-name { margin-right: auto; font-family: var(--font-family-code); font-size: 0.85em; color: var(--text-secondary); text-transform: uppercase; }
        .code-box-btn { display: flex; align-items: center; gap: 6px; padding: 4px 8px; background-color: transparent; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8em; color: var(--text-secondary); transition: background-color 0.2s, color 0.2s; }
        .code-box-btn:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .code-box-btn .material-symbols-outlined { font-size: 16px; }
        .code-box pre { margin: 0; }
        .code-box code { display: block; padding: 16px; font-family: var(--font-family-code); color: var(--text-primary); white-space: pre-wrap; word-wrap: break-word; overflow-x: auto; background-color: transparent; }
        
        /* Textarea Editor Styling */
        .code-editor-area {
            width: 100%;
            height: 500px;
            background-color: var(--bg-code);
            color: var(--text-primary);
            font-family: var(--font-family-code);
            font-size: 1rem;
            padding: 16px;
            border: none;
            resize: vertical;
            outline: none;
            display: none;
            white-space: pre;
            overflow-x: auto;
        }
        .code-box.editing .code-editor-area { display: block; }
        .code-box.editing pre { display: none; }

        .chat-footer { flex-shrink: 0; padding: 16px 24px; border-top: 1px solid var(--border-color); background: var(--bg-primary); }
        
        /* Custom Upload Area styling */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 0 16px 32px 16px;
            transition: border-color 0.2s;
            background: var(--bg-secondary);
        }
        .upload-area.dragover { border-color: var(--text-active); background: var(--bg-hover); }
        .upload-area p { color: var(--text-secondary); margin-top: 12px; }
        
        /* --- Modal Component --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 2000; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-header h2 { font-size: 1.25rem; font-weight: 600; }
        .modal-body p { color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6; }

        /* --- Auth Modal --- */
        .auth-view { display: none; }
        .auth-view.active { display: block; }
        .auth-footer-text { margin-top: 24px; text-align: center; font-size: 0.9rem; color: var(--text-secondary); }
        .auth-footer-text a { color: var(--text-active); font-weight: 500; }
        .auth-footer-text a:hover { text-decoration: underline; }
        .form-group-inline { display: flex; justify-content: flex-end; margin-bottom: 24px; }
        .form-group-inline a { font-size: 0.9rem; color: var(--text-active); }
        .form-group-inline a:hover { text-decoration: underline; }
        .auth-divider { display: flex; align-items: center; text-align: center; color: var(--text-secondary); font-size: 0.8rem; margin: 24px 0; }
        .auth-divider::before, .auth-divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--border-color); }
        .auth-divider:not(:empty)::before { margin-right: .5em; }
        .auth-divider:not(:empty)::after { margin-left: .5em; }
        .btn-google { width: 100%; display: flex; justify-content: center; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; background-color: #fff; color: #000; font-weight: 500; transition: opacity 0.2s; }
        .btn-google:hover { opacity: 0.9; }
        .btn-google svg { width: 18px; height: 18px; flex-shrink: 0; }
        .auth-error-message { color: var(--error-color); background-color: rgba(255, 138, 128, 0.1); border: 1px solid rgba(255, 138, 128, 0.3); padding: 12px; border-radius: 6px; margin-bottom: 16px; font-size: 0.9rem; text-align: center; display: none; }
        .auth-error-message.visible { display: block; }
        
        /* --- Form Group --- */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        .form-group input { width: 100%; background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; font-size: 1rem; color: var(--text-primary); outline: none; transition: border-color 0.2s; }
        .form-group input:focus { border-color: var(--text-active); }
        .btn { padding: 10px 20px; font-weight: 600; border-radius: 8px; transition: background-color 0.2s, color 0.2s, opacity 0.2s; width: 100%;}
        .btn-primary { background-color: var(--text-active); color: var(--bg-primary); }
        .btn-primary:hover:not(:disabled) { opacity: 0.9; }
        .btn-secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--bg-hover); }
        .btn:disabled { opacity: 0.6; cursor: wait; }

        /* --- Responsive & Overlay --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        body.left-sidebar-open .overlay { opacity: 1; visibility: visible; }
        @media (min-width: 1024px) {
            #left-sidebar { position: static; transform: none; }
            .icon-button#menu-toggle { display: none; }
        }
        
        /* Loader */
        .typing-indicator { display: none; align-items: center; gap: 8px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px 20px; color: var(--text-secondary); font-style: italic; font-size: 0.9rem; margin: 10px 16px; }
        .typing-indicator.active { display: flex; }
        .typing-indicator .dot { width: 8px; height: 8px; background-color: var(--text-secondary); border-radius: 50%; animation: typing-bounce 1.2s infinite ease-in-out; }
        .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        /* --- Click Animations (Added) --- */
        button, .btn, .icon-button, .sidebar-nav a, .history-item, .upload-area {
            transition: all 0.2s ease;
        }
        button:active, .btn:active, .icon-button:active {
            transform: scale(0.92);
        }
        .sidebar-nav a:active, .history-item:active, .upload-area:active {
            transform: scale(0.98);
        }

    </style>
</head>
<body>

    <div class="app-container">
        <!-- Sidebar -->
        <aside id="left-sidebar">
            <div class="sidebar-content">
                <div class="sidebar-header">HaiCloud</div>
                <nav class="sidebar-nav">
                    <a href="#" class="active" onclick="showScreen('home')">
                        <span class="material-symbols-outlined">home</span>
                        Home
                    </a>
                    <a href="#" onclick="showScreen('files')">
                        <span class="material-symbols-outlined">folder_open</span>
                        My Files
                    </a>
                    <a href="#" onclick="showScreen('profile')">
                        <span class="material-symbols-outlined">person</span>
                        Profile
                    </a>
                </nav>
                <div class="sidebar-footer">
                    <nav class="sidebar-nav">
                        <button id="logout-btn">
                            <span class="material-symbols-outlined">logout</span>
                            Sign Out
                        </button>
                    </nav>
                </div>
            </div>
        </aside>

        <!-- Overlay for Mobile -->
        <div class="overlay" onclick="toggleSidebar()"></div>

        <!-- Main Content -->
        <main class="main-wrapper">
            <header class="main-header">
                <button class="icon-button" id="menu-toggle" onclick="toggleSidebar()">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <div class="header-title">HaiCloud</div>
                <div style="margin-left: auto;">
                    <span id="user-email-display" style="font-size: 0.9rem; color: var(--text-secondary);"></span>
                </div>
            </header>

            <div class="content-area">
                
                <!-- Home/Upload Screen -->
                <section id="home-screen" class="screen active">
                    <div class="content-wrapper">
                        
                        <!-- Header Text Removed as requested -->

                        <div class="upload-area" id="drop-zone">
                            <span class="material-symbols-outlined" style="font-size: 48px; color: var(--text-active);">text_snippet</span>
                            <h3>Drag & Drop text files here</h3>
                            <p>or</p>
                            <button class="btn btn-primary" onclick="document.getElementById('file-input').click()" style="width: auto; margin-top: 10px;">Browse Files</button>
                            <input type="file" id="file-input" class="visually-hidden" accept=".txt,.html,.css,.js,.py,.json,.md,.xml,.csv">
                        </div>

                        <!-- CREATE NEW BUTTON SECTION (Moved below upload area) -->
                        <div style="padding: 0 16px; margin-bottom: 24px;">
                            <button class="btn" onclick="openCreateModal()" style="width: 100%; background-color: #2979ff; color: white; display: flex; justify-content: center; align-items: center; gap: 8px;">
                                <span class="material-symbols-outlined">add_circle</span>
                                Create New File
                            </button>
                        </div>

                        <div class="typing-indicator" id="upload-loader">
                            Saving text to database <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                        </div>

                    </div>
                </section>

                <!-- Files List Screen -->
                <section id="files-screen" class="screen">
                    <div class="content-wrapper">
                        <div class="page-header">
                            <h2>My Saved Text</h2>
                        </div>
                        <div id="file-list-container">
                            <!-- Items injected via JS -->
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">Loading...</div>
                        </div>
                    </div>
                </section>

                <!-- Viewer/Code Screen -->
                <section id="viewer-screen" class="screen">
                    <div class="chat-content-wrapper">
                        <div class="page-header">
                            <button class="icon-button" onclick="showScreen('files')" style="display: inline-flex; margin-right: 10px;">
                                <span class="material-symbols-outlined">arrow_back</span>
                            </button>
                            <span id="viewer-filename" style="font-size: 1.5rem; font-weight: 600;">filename.txt</span>
                        </div>
                        
                        <div class="code-box" id="code-box-container">
                            <div class="code-box-header">
                                <span class="lang-name" id="viewer-lang">TEXT</span>
                                
                                <!-- View Mode Buttons -->
                                <div id="view-mode-buttons" style="display: flex; gap: 8px;">
                                    <button class="code-box-btn" id="viewer-preview-btn" style="display: none;" onclick="previewFileCurrent()">
                                        <span class="material-symbols-outlined">preview</span>
                                        Preview
                                    </button>
                                    <button class="code-box-btn" onclick="downloadCurrentFile()">
                                        <span class="material-symbols-outlined">download</span>
                                        Export
                                    </button>
                                    <button class="code-box-btn" onclick="copyContent()">
                                        <span class="material-symbols-outlined">content_copy</span>
                                        Copy
                                    </button>
                                    <button class="code-box-btn" onclick="toggleEditMode(true)">
                                        <span class="material-symbols-outlined">edit</span>
                                        Edit
                                    </button>
                                </div>

                                <!-- Edit Mode Buttons -->
                                <div id="edit-mode-buttons" style="display: none; gap: 8px;">
                                    <button class="code-box-btn" onclick="toggleEditMode(false)">
                                        <span class="material-symbols-outlined">close</span>
                                        Cancel
                                    </button>
                                    <button class="code-box-btn" onclick="saveFileChanges()" style="background-color: var(--text-active); color: var(--bg-primary); border:none;">
                                        <span class="material-symbols-outlined">save</span>
                                        Save
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Editor Textarea (Hidden by default) -->
                            <textarea id="viewer-editor" class="code-editor-area" spellcheck="false"></textarea>
                            
                            <!-- Display Code -->
                            <pre><code id="viewer-code-content">Loading content...</code></pre>
                        </div>
                    </div>
                </section>

                <!-- Profile Screen -->
                <section id="profile-screen" class="screen">
                    <div class="content-wrapper">
                        <div class="page-header"><h2>Profile</h2></div>
                        <div class="profile-card">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="text" id="profile-email" readonly disabled>
                            </div>
                            <div class="form-group">
                                <label>User ID</label>
                                <input type="text" id="profile-uid" readonly disabled>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Create File Modal -->
    <div class="modal-overlay" id="create-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New File</h2>
            </div>
            <div class="modal-body">
                <p>Enter a filename (e.g. script.js, notes.txt) to start editing.</p>
                <div class="form-group">
                    <label>Filename</label>
                    <input type="text" id="new-filename" placeholder="example.txt">
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button class="btn btn-secondary" style="flex:1;" onclick="closeCreateModal()">Cancel</button>
                    <button class="btn btn-primary" style="flex:1; background-color: #2979ff;" onclick="createNewFile()">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="auth-modal">
        <div class="modal-content">
            <!-- Login View -->
            <div id="login-view" class="auth-view active">
                <div class="modal-header">
                    <h2>Welcome Back</h2>
                </div>
                <div class="modal-body">
                    <p>Sign in to save and view your code snippets.</p>
                    <div class="auth-error-message" id="auth-error"></div>
                    
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" placeholder="Enter password">
                    </div>
                    
                    <button class="btn btn-primary" id="btn-signin-email">Sign In</button>
                    
                    <div class="auth-divider">OR</div>
                    
                    <button class="btn-google" id="btn-signin-google">
                        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Continue with Google
                    </button>

                    <div class="auth-footer-text">
                        Don't have an account? <a href="#" onclick="toggleAuthView('register')">Sign up</a>
                    </div>
                </div>
            </div>

            <!-- Register View -->
            <div id="register-view" class="auth-view">
                <div class="modal-header">
                    <h2>Create Account</h2>
                </div>
                <div class="modal-body">
                    <div class="auth-error-message" id="reg-error"></div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="reg-email" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="reg-password" placeholder="Create password">
                    </div>
                    
                    <button class="btn btn-primary" id="btn-signup-email">Sign Up</button>
                    
                    <div class="auth-footer-text">
                        Already have an account? <a href="#" onclick="toggleAuthView('login')">Sign in</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, Timestamp, doc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyANgmoi_K7dD5FxsZ8SYjAzlX7x0Nbc5_o",
            authDomain: "haimovie.firebaseapp.com",
            databaseURL: "https://haimovie-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "haimovie",
            storageBucket: "haimovie.firebasestorage.app",
            messagingSenderId: "648493605922",
            appId: "1:648493605922:web:d019cea2428dfcf6aa567b",
            measurementId: "G-2VCH5S0JQY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const authModal = document.getElementById('auth-modal');
        const fileListContainer = document.getElementById('file-list-container');
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const uploadLoader = document.getElementById('upload-loader');
        const viewerCode = document.getElementById('viewer-code-content');
        const viewerEditor = document.getElementById('viewer-editor');
        const codeBoxContainer = document.getElementById('code-box-container');
        const viewModeButtons = document.getElementById('view-mode-buttons');
        const editModeButtons = document.getElementById('edit-mode-buttons');
        const createModal = document.getElementById('create-modal');
        const newFilenameInput = document.getElementById('new-filename');
        
        // Cache to store loaded files content temporarily
        const fileCache = new Map();
        let currentViewerDocId = null;

        // --- Authentication Logic ---
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authModal.classList.remove('visible');
                document.getElementById('user-email-display').textContent = user.email;
                document.getElementById('profile-email').value = user.email;
                document.getElementById('profile-uid').value = user.uid;
                loadUserFiles(user.uid);
            } else {
                authModal.classList.add('visible');
                document.getElementById('user-email-display').textContent = '';
                fileListContainer.innerHTML = '<div style="text-align:center; padding:20px;">Please sign in to view files.</div>';
            }
        });

        document.getElementById('btn-signin-google').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                showError('auth-error', error.message);
            }
        });

        document.getElementById('btn-signin-email').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                showError('auth-error', error.message);
            }
        });

        document.getElementById('btn-signup-email').addEventListener('click', async () => {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                showError('reg-error', error.message);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
            window.toggleSidebar(); // Close sidebar on mobile
        });

        // --- Create New File Logic ---

        window.openCreateModal = () => {
            createModal.classList.add('visible');
            newFilenameInput.value = '';
            newFilenameInput.focus();
        };

        window.closeCreateModal = () => {
            createModal.classList.remove('visible');
        };

        window.createNewFile = async () => {
            const user = auth.currentUser;
            if (!user) {
                alert("Please sign in.");
                return;
            }

            const filename = newFilenameInput.value.trim();
            if(!filename) {
                alert("Please enter a filename.");
                return;
            }

            try {
                // Create document in Firestore with empty content
                const docRef = await addDoc(collection(db, "files"), {
                    name: filename,
                    content: "", // Empty start
                    type: 'text/plain', // Default
                    size: 0,
                    userId: user.uid,
                    createdAt: Timestamp.now()
                });

                closeCreateModal();
                
                // Add to cache so we can view immediately
                fileCache.set(docRef.id, "");

                // Open in Editor Mode immediately
                viewFile(docRef.id, filename);
                toggleEditMode(true);
                alert("File created! Start typing...");

                // Refresh list in background
                loadUserFiles(user.uid);

            } catch (error) {
                console.error("Error creating file:", error);
                alert("Error: " + error.message);
            }
        };


        // --- Text Upload Logic (Direct to Firestore) ---

        function handleFileUpload(file) {
            const user = auth.currentUser;
            if (!user) return;

            // Firestore document size limit is ~1MB
            if(file.size > 900000) {
                alert("File is too large for database storage (Max ~900KB for text mode).");
                return;
            }

            uploadLoader.classList.add('active');

            const reader = new FileReader();

            reader.onload = async (e) => {
                const textContent = e.target.result;
                
                try {
                    // Save metadata AND content directly to Firestore
                    await addDoc(collection(db, "files"), {
                        name: file.name,
                        content: textContent, // Storing the actual code/text here
                        type: file.type || 'text/plain',
                        size: file.size,
                        userId: user.uid,
                        createdAt: Timestamp.now()
                    });

                    uploadLoader.classList.remove('active');
                    alert('Text content saved to database!');
                    showScreen('files');
                    loadUserFiles(user.uid);
                } catch (error) {
                    console.error("Error saving text:", error);
                    let msg = error.message;
                    if(msg.includes("permission-denied")) {
                        msg = "Permission denied. Check Firestore Rules in Firebase Console.";
                    }
                    alert("Error saving: " + msg);
                    uploadLoader.classList.remove('active');
                }
            };

            reader.onerror = () => {
                alert("Failed to read file");
                uploadLoader.classList.remove('active');
            };

            // Read the file as text immediately
            reader.readAsText(file);
        }

        fileInput.addEventListener('change', (e) => {
            if(e.target.files[0]) handleFileUpload(e.target.files[0]);
        });

        // Drag and Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0]);
        });

        // --- File Listing & Viewing ---

        async function loadUserFiles(userId) {
            fileListContainer.innerHTML = '<div class="typing-indicator active" style="display:flex; justify-content:center; border:none;">Loading...</div>';
            
            // Clear cache on reload
            fileCache.clear();

            // Client-side sorting to avoid index requirements
            const q = query(collection(db, "files"), where("userId", "==", userId));
            
            try {
                const querySnapshot = await getDocs(q);
                fileListContainer.innerHTML = '';
                
                if (querySnapshot.empty) {
                    fileListContainer.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No text files saved yet.</div>';
                    return;
                }

                // Convert to array and Sort Client Side
                const docs = [];
                querySnapshot.forEach((doc) => {
                    docs.push({ id: doc.id, ...doc.data() });
                });

                // Sort by createdAt descending
                docs.sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);

                docs.forEach((data) => {
                    const docId = data.id;
                    
                    // Store content in memory map to avoid fetching again
                    fileCache.set(docId, data.content);

                    // Check if it is HTML for preview button
                    const isHtml = data.name.toLowerCase().endsWith('.html');

                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="history-item-info" onclick="viewFile('${docId}', '${data.name}')">
                            <p>${data.name}</p>
                            <span>${formatBytes(data.size)} â€¢ ${data.type}</span>
                        </div>
                        <div class="file-actions">
                             ${isHtml ? `
                             <button class="icon-button" onclick="previewFile('${docId}')" title="Preview HTML">
                                <span class="material-symbols-outlined">preview</span>
                            </button>` : ''}
                            
                            <button class="icon-button" onclick="downloadFile('${docId}', '${data.name}')" title="Export/Download">
                                <span class="material-symbols-outlined">download</span>
                            </button>

                             <button class="icon-button" onclick="viewFile('${docId}', '${data.name}')" title="View/Edit">
                                <span class="material-symbols-outlined">edit</span>
                            </button>

                            <button class="icon-button" onclick="deleteFile('${docId}')" title="Delete" style="color: var(--error-color);">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </div>
                    `;
                    fileListContainer.appendChild(item);
                });
            } catch (e) {
                console.error(e);
                
                let errorMsg = e.message;
                if(errorMsg.includes("permission-denied")) {
                    errorMsg = "Permission Denied: Please set Firestore Rules to 'allow read, write: if request.auth != null;'";
                }
                fileListContainer.innerHTML = `<div style="text-align:center; color:var(--error-color); padding:20px;">${errorMsg}</div>`;
            }
        }

        // --- Global Actions (Delete, Download, Preview, Edit) ---

        window.deleteFile = async (docId) => {
            if(confirm("Are you sure you want to permanently delete this file?")) {
                try {
                    await deleteDoc(doc(db, "files", docId));
                    fileCache.delete(docId);
                    // Refresh list
                    if(auth.currentUser) loadUserFiles(auth.currentUser.uid);
                    // If viewing this file, go back
                    if(currentViewerDocId === docId) showScreen('files');
                } catch (e) {
                    alert("Error deleting: " + e.message);
                }
            }
        };

        window.downloadFile = (docId, fileName) => {
            const content = fileCache.get(docId);
            if(!content) return alert("Content not loaded.");
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.previewFile = (docId) => {
            const content = fileCache.get(docId);
            if(!content) return alert("Content not loaded.");
            
            const win = window.open();
            win.document.write(content);
            win.document.close();
        };

        // --- Viewer Logic ---

        window.viewFile = (docId, name) => {
            // Reset Edit Mode before opening
            toggleEditMode(false);
            
            showScreen('viewer');
            currentViewerDocId = docId;
            document.getElementById('viewer-filename').textContent = name;
            document.getElementById('viewer-lang').textContent = name.split('.').pop().toUpperCase();
            
            // Show/Hide Preview button in viewer
            const previewBtn = document.getElementById('viewer-preview-btn');
            if(name.toLowerCase().endsWith('.html')) {
                previewBtn.style.display = 'flex';
            } else {
                previewBtn.style.display = 'none';
            }

            // Retrieve content from cache
            const content = fileCache.get(docId);
            
            if (content !== undefined) {
                viewerCode.textContent = content;
                viewerEditor.value = content; // Populate editor just in case
            } else {
                viewerCode.textContent = "Error: Content not found in cache.";
                viewerEditor.value = "";
            }
        };

        window.toggleEditMode = (enable) => {
            if (enable) {
                codeBoxContainer.classList.add('editing');
                viewModeButtons.style.display = 'none';
                editModeButtons.style.display = 'flex';
                // Sync content from display to editor
                viewerEditor.value = viewerCode.textContent;
            } else {
                codeBoxContainer.classList.remove('editing');
                viewModeButtons.style.display = 'flex';
                editModeButtons.style.display = 'none';
            }
        };

        window.saveFileChanges = async () => {
            if (!currentViewerDocId) return;
            
            const newContent = viewerEditor.value;
            
            try {
                // Update Firestore
                await updateDoc(doc(db, "files", currentViewerDocId), {
                    content: newContent,
                    size: new Blob([newContent]).size // update approximate size
                });

                // Update Cache and UI
                fileCache.set(currentViewerDocId, newContent);
                viewerCode.textContent = newContent;
                
                alert("File saved successfully!");
                toggleEditMode(false);
                
                // Reload list to update file sizes if changed
                if(auth.currentUser) loadUserFiles(auth.currentUser.uid);

            } catch (e) {
                console.error(e);
                alert("Error saving file: " + e.message);
            }
        };

        window.previewFileCurrent = () => {
            if(currentViewerDocId) window.previewFile(currentViewerDocId);
        };

        window.downloadCurrentFile = () => {
            if(currentViewerDocId) {
                const name = document.getElementById('viewer-filename').textContent;
                window.downloadFile(currentViewerDocId, name);
            }
        };

        window.copyContent = () => {
            const textToCopy = codeBoxContainer.classList.contains('editing') ? viewerEditor.value : viewerCode.textContent;
            navigator.clipboard.writeText(textToCopy)
                .then(() => alert('Copied to clipboard!'));
        }

        // --- UI Helpers ---

        window.toggleSidebar = () => {
            document.body.classList.toggle('left-sidebar-open');
        };

        window.showScreen = (screenName) => {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
            
            // Show target
            if(screenName === 'files') {
                document.getElementById('files-screen').classList.add('active');
                document.querySelector('.sidebar-nav a:nth-child(2)').classList.add('active');
            } else if (screenName === 'profile') {
                document.getElementById('profile-screen').classList.add('active');
                document.querySelector('.sidebar-nav a:nth-child(3)').classList.add('active');
            } else if (screenName === 'viewer') {
                document.getElementById('viewer-screen').classList.add('active');
            } else {
                document.getElementById('home-screen').classList.add('active');
                document.querySelector('.sidebar-nav a:nth-child(1)').classList.add('active');
            }

            // Close sidebar on mobile selection
            if(window.innerWidth < 1024) document.body.classList.remove('left-sidebar-open');
        };

        window.toggleAuthView = (view) => {
            document.querySelectorAll('.auth-view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${view}-view`).classList.add('active');
            document.querySelectorAll('.auth-error-message').forEach(e => e.classList.remove('visible'));
        };

        function showError(elementId, msg) {
            const el = document.getElementById(elementId);
            el.textContent = msg;
            el.classList.add('visible');
        }

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

    </script>
</body>
</html>